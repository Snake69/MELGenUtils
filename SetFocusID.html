<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<link rel="shortcut icon" href="Include/favicon.ico">
<title>Set Focus ID</title>

<style type="text/css">
    * {
        text-align: center;
    }
    body {
        background-color: #ffffff;
    }
</style>

<script>
    /* to prevent Firefox FOUC, this must be here */
    let FF_FOUC_FIX;
</script>

</head>
<body>

<script>

var DBType;
onload = function () {
    const ws = new WebSocket('ws://localhost:3000/');

    ws.onopen = function() {
        ws.send("ID");
        ws.onmessage = function(e) {
            document.getElementById("IndID").setAttribute('value',e.data);

            ws.send("DBFormat");
            ws.onmessage = function(e) {
                if (e.data == 'G') {
                    var span = document.getElementById("dial1span");
                    var msg = "This function does not yet work with a Gedcom DataBase.<br> <br>";
                    const dialog1 = document.querySelector("#dial1");
                    span.innerHTML = msg;
                    dialog1.showModal();
                }
                DBType = e.data;
            }
        }
    }
}

</script>

<dialog id="dial1">
<span id="dial1span"></span>
<form method="dialog">
<button type="submit">OK</button>
</form>
</dialog>

<dialog class="dialog2" id="dialog2">
<span class="dial2span" id="dialog2span"></span>
<form method="dialog">
<button class="OK" onclick="DoSetID()">OK</button>
<button formmethod="dialog" class="CANCEL">Cancel</button>
</form>
</dialog>

<h1>Set Focus ID for Active DataBase</h1>
<span id="TitleDBName"></span>
<hr style="width:50%">

<form id="SetFocusID" method="POST">

<input type="hidden" name="ORIGIN" value="SetFocusID">

<br> <br>
<label> Enter Focus ID for Active DataBase: <input type="text" id="IndID" name="IndID"> </label>
<br> <br>
<br> <br>

<button type="button" onclick='SetFocusID()'> OK </button>

</form>

<script>

var IndID;

function SetFocusID() {
    const ws = new WebSocket('ws://localhost:3000/');
    var send2node = '', alerterr = '';

    IndID = document.getElementById('IndID').value.trim();

    if (isNaN(IndID[0]) || isNaN(IndID[IndID.length - 1]))
        alerterr += "The first position and the last position in the Focus ID must be a number.<br> <br>";
    if (IndID.indexOf(".") == -1)
        alerterr += "The Focus ID must contain at least one period.<br> <br>";
    if (IndID == "")
        alerterr = "A Focus ID is required.<br> <br>";

    if (alerterr != '') {
        var span = document.getElementById("dial1span");
        var msg = alerterr;
        const dialog1 = document.querySelector("#dial1");
        span.innerHTML = msg;
        dialog1.showModal();
        return;
    }

    ws.onopen = function() {
        ws.send("SetFocusID" + IndID);
        ws.onmessage = function(e) {
            if (e.data.search("not found") != -1 || e.data.search("not verified") != -1) {
                var span = document.getElementById("dial1span");
                const dialog1 = document.querySelector("#dial1");
                span.innerHTML = e.data;
                dialog1.showModal();
            }
            else {
                var span = document.getElementById("dialog2span");
                const dialog2 = document.querySelector("#dialog2");
                span.innerHTML = e.data + "<br>Click OK to accept this person as the new Focus ID, otherwise click Cancel.<br> <br>";
                dialog2.showModal();
            }
        }
    }
}

function DoSetID () {
    const ws = new WebSocket('ws://localhost:3000/');

    ws.onopen = function() {
        ws.send("DoSetID" + IndID);
        ws.onmessage = function(e) {
            var span = document.getElementById("dial1span");
            const dialog1 = document.querySelector("#dial1");
            span.innerHTML = e.data;
            dialog1.showModal();
        }
    }
}

onload = function init() {
    const ws = new WebSocket('ws://localhost:3000/');
    ws.onopen = function() {
        ws.send("DBName");
    }
    ws.onmessage = function(e) {
        if (e.data != -1)
            document.getElementById("TitleDBName").innerHTML = '(' + e.data + ')'; 
    }
}

window.addEventListener('message', (e) => {
    if (e.data.type === 'sse') {
        const sseEventType = e.data.sseEventType;

        if (sseEventType == "monitorweb-update")
            alert(e.data.message);
        if (sseEventType == "verify-progress-update")
            console.log(e.data.message);
    }
})

</script>

<iframe src="sse-handler.html" style="display: none;" id="sse-frame"></iframe>

<br>
<hr style="width:50%">

</body>
</html>
